{% extends 'base.html' %}

{% load static %}

{% block title %}Donasi Buku{% endblock title %}

{% block meta %}
<style>
    .status {
        color: #000;
        font-family: Montserrat;
        font-size: 24px;
        font-style: normal;
        font-weight: 500;
        line-height: normal;
        margin-bottom: 0px;
    }

    .info_buku {
        color: #000;
        font-family: Montserrat;
        font-size: 15px;
        font-style: normal;
        font-weight: 400;
        line-height: normal;
        margin-bottom: 0px;
    }

    #main_list {
        background: #EDEDED;
        align-items: center;
        padding-top: 20px;
        padding-bottom: 20px;
        padding-right: 20px;
        padding-left: 20px;
        margin-right: 25px;
        margin-left: 25px;
        margin-top: 20px;
        margin-bottom: 10px;
        border-radius: 15px;
        flex-shrink: 0;
        box-shadow: 6px 8px 4px 0px rgba(0, 0, 0, 0.25);
    }

    #icon_div {
        text-align: left;
        width: 127px;
        height: 102px;
        border-radius: 10px;
        background: #9BD4E4;
    }

    #tempat_status {
        text-align: right;
    }

    #PENDING_button {
        align-items: center;
        justify-content: center;
        background: #FFD699;
        display: inline-block;
        margin-right: 24px;
        border-radius: 10px;
    }

    #button_request {
        width: 90%;
        margin-top: 20px;
        margin-right: 24px;
        margin-left: 25px;
    }

    #icon_background {
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    #book_logo {
        width: 70%;
        height: 70%;
    }
</style>
{% endblock meta %}

{% block content %}
<div style="opacity: 1; height: 600px;background-image: url({% static 'library_background.png' %});background-position: center;background-size: cover;">
    <div class="container h-100">
        <div class="row h-100">
            <div
                class="col-sm-12 col-md-6 text-center text-md-start d-flex d-sm-flex d-md-flex justify-content-center align-items-center justify-content-md-start align-items-md-center justify-content-xl-center">
                <div style="max-width: 350px;">
                    <h1 class="text-uppercase fw-bold" style="color: white;">Flex-Lib<br>Donasi Buku</h1>
                    <p class="my-3" style="color: white;">Di Flex-lib kamu dapat mendonasikan buku-bukumu yang sudah
                        tidak dipakai lagi. Dengan bantuanmu, katalog buku Flex-lib dapat menjadi semakin luas dan
                        lengkap.</p>
                    <a class="btn btn-primary btn-lg me-2" role="button" data-bs-toggle="modal"
                        data-bs-target="#modalDonation">Donasi Buku Sekarang</a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container mt-5">
    <div id="donation_list" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4"></div>

    <div class="modal fade" id="modalDonation" tabindex="-1" aria-labelledby="modalDonationLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">Donate Book</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="form" onsubmit="return false;">
                        {% csrf_token %}
                        {{ form.as_p }}
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="button_add" data-bs-dismiss="modal">Donate</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    async function getDonations() {
        return fetch("{% url 'donasi_buku:get_donations' %}").then((res) => res.json())
    }

    async function refreshDonations() {
        document.getElementById("donation_list").innerHTML = ""
        const donations = await getDonations()
        let htmlString = ""
        donations.forEach(element => {
            let imgSrc = "{% static 'icon.png' %}"
            if (element.fields.image_url !== "" && element.fields.image_url !== null) {
                imgSrc = element.fields.image_url
            }
            console.log(imgSrc)
            htmlString += `\n
            <div class="col">
                <div class="shadow bg-body rounded">
                    <div class="card text-dark bg-light h-100">
                        <div class="text-center p-3">
                            <img src="${imgSrc}" style="object-fit: fill; width: 150px; height: 200px;" class="card-img-top" alt="...">
                        </div>
                        <div class="card-body">
                            <h5 class="card-title text-center" style="margin-bottom: 1rem;">${element.fields.title}</h5>
                            <div class="row">
                                <div class="col-md-12 col-lg-6">
                                    <h6 class="card-title">Author</h6>
                                    <p class="card-subtitle mb-2">${element.fields.author}</p>
                                </div>
                                <div class="col-md-12 col-lg-6">
                                    <h6 class="card-title">Year</h6>
                                    <p class="card-subtitle mb-2">${element.fields.year}</p>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12 col-lg-6">
                                    <h6 class="card-title">Donated on</h6>
                                    <p class="card-subtitle mb-2">${element.fields.donation_date}</p>
                                </div>
                                <div class="col-md-12 col-lg-6">
                                    <h6 class="card-title">Amount</h6>
                                    <p class="card-subtitle mb-3">${element.fields.donation_amount} books</p>
                                </div>
                            </div>
                            <div class="row text-center">
                                <div class="col">
                                    <button type="button" class="btn btn-primary" onclick=deleteDonation(${element.pk})>Cancel Donation</button>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer">
                            <small class="text-muted">Status: ${element.fields.status}</small>
                        </div>
                    </div>
                </div>
            </div>`
        });
        document.getElementById("donation_list").innerHTML = htmlString
    }

    async function deleteDonation(id) {
        await fetch("{% url 'donasi_buku:delete_donation_ajax' 9999 %}".replace(9999, id), {
            method: "DELETE"
        }).then(refreshDonations)
    }

    function addDonation() {
        fetch("{% url 'donasi_buku:donate_book_ajax' %}", {
            method: "POST",
            body: new FormData(document.querySelector('#form'))
        }).then(refreshDonations)
        document.getElementById("form").reset()
        return false
    }

    refreshDonations()
    document.getElementById("button_add").onclick = addDonation
</script>
{% endblock content %}